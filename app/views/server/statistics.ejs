<%- include('../components/top') %>
<main class="flex-grow container mx-auto px-4 py-8">
    <%- include('../components/server_header', {
        backButtonText: __('server.statistics.back_to_list')
    }) %>
<div id="alert-container" class="mb-4 space-y-2"></div>
    <%- include('../components/server') %>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
        <!-- CPU Usage -->
        <div class="bg-white/5 rounded-xl p-6">
            <h3 class="text-gray-400 text-sm font-medium"><%= __('server.statistics.cpu_usage') %></h3>
            <div class="mt-2 flex items-baseline">
                <p class="text-2xl font-semibold text-white" id="cpu-usage">0%</p>
                <p class="ml-2 text-sm text-gray-400" id="cpu-trend"></p>
            </div>
            <div class="mt-3 h-[60px]">
                <canvas id="cpu-chart"></canvas>
            </div>
        </div>

        <!-- Memory Usage -->
        <div class="bg-white/5 rounded-xl p-6">
            <h3 class="text-gray-400 text-sm font-medium"><%= __('server.statistics.memory_usage') %></h3>
            <div class="mt-2 flex items-baseline">
                <p class="text-2xl font-semibold text-white" id="memory-usage">0 MB</p>
                <p class="ml-2 text-sm text-gray-400" id="memory-total"></p>
            </div>
            <div class="mt-3 h-[60px]">
                <canvas id="memory-chart"></canvas>
            </div>
        </div>

        <!-- Network Traffic -->
        <div class="bg-white/5 rounded-xl p-6">
            <h3 class="text-gray-400 text-sm font-medium"><%= __('server.statistics.network_traffic') %></h3>
            <div class="mt-2 flex items-baseline">
                <p class="text-2xl font-semibold text-white" id="network-usage">0 B/s</p>
                <p class="ml-2 text-sm text-gray-400" id="network-trend"></p>
            </div>
            <div class="mt-3 h-[60px]">
                <canvas id="network-chart"></canvas>
            </div>
        </div>

        <!-- Disk Usage -->
        <div class="bg-white/5 rounded-xl p-6">
            <h3 class="text-gray-400 text-sm font-medium"><%= __('server.statistics.disk_usage') %></h3>
            <div class="mt-2 flex items-baseline">
                <p class="text-2xl font-semibold text-white" id="disk-usage">0 MB</p>
                <p class="ml-2 text-sm text-gray-400" id="disk-total"></p>
            </div>
            <div class="mt-3 h-[60px]">
                <canvas id="disk-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Charts -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <div class="bg-white/5 rounded-xl p-6">
            <h2 class="text-lg font-medium text-white mb-4"><%= __('server.statistics.resource_usage') %></h2>
            <div class="h-[240px]">
                <canvas id="resource-chart"></canvas>
            </div>
        </div>
        <div class="bg-white/5 rounded-xl p-6">
            <h2 class="text-lg font-medium text-white mb-4"><%= __('server.statistics.network_activity') %></h2>
            <div class="h-[240px]">
                <canvas id="network-detail-chart"></canvas>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>

<script type="module">
let serverId = '<%- req.query.id %>'
// Configuration and utilities
const MAX_HISTORY = 150;
let socket;
let startTime = Date.now();
let lastStats = null;

// Chart defaults
Chart.defaults.color = '#9CA3AF';
Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
Chart.defaults.elements.line.borderWidth = 2;
Chart.defaults.elements.point.radius = 0;

// Data structures for metrics history
const metricsHistory = {
    cpu: new Array(MAX_HISTORY).fill(0),
    memory: new Array(MAX_HISTORY).fill(0),
    network: new Array(MAX_HISTORY).fill(0),
    disk: new Array(MAX_HISTORY).fill(0)
};

// Utility functions
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}

// Create mini chart
function createMiniChart(elementId, color) {
    return new Chart(document.getElementById(elementId), {
        type: 'line',
        data: {
            labels: new Array(MAX_HISTORY).fill(''),
            datasets: [{
                data: new Array(MAX_HISTORY).fill(0),
                borderColor: color,
                backgroundColor: color.replace(')', ', 0.1)'),
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { display: false, min: 0 }
            },
            animation: false
        }
    });
}

let disk_limit_megabytes;
let memory_limit_megabytes;
let cpu_limit;

try {
  // Gets the server stats as it is provided in megabytes
  const response = await fetch(`/api/server/${serverId}`);
  
  if (!response.ok) console.log('Could not fetch stats: ' + response.status);
  
  const data = await response.json();
  
  disk_limit_megabytes = data.attributes.limits.disk;
  cpu_limit = data.attributes.limits.cpu;
  memory_limit_megabytes = data.attributes.limits.memory;
} catch(error) {
  console.log('Error fetching stats: ' + error);
  showAlert('error', 'Error', 'Failed to fetch server stats. Please try refreshing the page.');
}

const charts = {
    cpu: createMiniChart('cpu-chart', 'rgb(129, 140, 248)'),
    memory: createMiniChart('memory-chart', 'rgb(52, 211, 153)'),
    network: createMiniChart('network-chart', 'rgb(59, 130, 246)'),
    disk: createMiniChart('disk-chart', 'rgb(167, 139, 250)'),
    resource: new Chart(document.getElementById('resource-chart'), {
        type: 'line',
        data: {
            datasets: [{
                label: 'CPU',
                data: [],
                borderColor: 'rgb(129, 140, 248)',
                backgroundColor: 'rgba(129, 140, 248, 0.1)',
                fill: true
            }, {
                label: 'Memory',
                data: [],
                borderColor: 'rgb(52, 211, 153)',
                backgroundColor: 'rgba(52, 211, 153, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',  // Changed from 'time' to 'linear'
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    suggestedMax: Math.min(cpu_limit, 100),
                    ticks: {
                        callback: value => `${value}%`
                    }
                }
            },
            animation: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true
                    }
                }
            }
        }
    }),
    networkDetail: new Chart(document.getElementById('network-detail-chart'), {
        type: 'line',
        data: {
            datasets: [{
                label: 'Inbound',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true
            }, {
                label: 'Outbound',
                data: [],
                borderColor: 'rgb(239, 68, 68)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',  // Changed from 'time' to 'linear'
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => formatBytes(value) + '/s'
                    }
                }
            },
            animation: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true
                    }
                }
            }
        }
    })
};

// Modify the updateMetrics function to use simple indices instead of timestamps
let dataIndex = 0;

function updateMetrics(stats) {
    // Update CPU
    document.getElementById('cpu-usage').textContent = `${stats.cpu_absolute.toFixed(1)}%`;
    document.getElementById('cpu-trend').textContent = `/ ${cpu_limit.toFixed(1)}%`;
    metricsHistory.cpu.push(stats.cpu_absolute);
    metricsHistory.cpu.shift();
    charts.cpu.data.datasets[0].data = [...metricsHistory.cpu];
    charts.cpu.update();

    // Update Memory
    const memory_limit_bytes = memory_limit_megabytes * 1024 * 1024;
    const memoryPercentage = (stats.memory_bytes / memory_limit_bytes) * 100;
    document.getElementById('memory-usage').textContent = formatBytes(stats.memory_bytes);
    document.getElementById('memory-total').textContent = `/ ${formatBytes(memory_limit_bytes)}`;
    metricsHistory.memory.push(memoryPercentage);
    metricsHistory.memory.shift();
    charts.memory.data.datasets[0].data = [...metricsHistory.memory];
    charts.memory.update();

    // Update Network
    document.getElementById('network-usage').textContent = `${formatBytes(stats.network.tx_bytes)}/s`;
    document.getElementById('network-trend').textContent = `â†“ ${formatBytes(stats.network.rx_bytes)}/s`;
    metricsHistory.network.push(stats.network.tx_bytes);
    metricsHistory.network.shift();
    charts.network.data.datasets[0].data = [...metricsHistory.network];
    charts.network.update();

    // Update Disk
    const disk_limit_bytes = disk_limit_megabytes * 1024 * 1024;
    const diskPercentage = (stats.disk_bytes / disk_limit_bytes) * 100;
    document.getElementById('disk-usage').textContent = formatBytes(stats.disk_bytes);
    document.getElementById('disk-total').textContent = `/ ${formatBytes(disk_limit_bytes)}`;
    metricsHistory.disk.push(diskPercentage);
    metricsHistory.disk.shift();
    charts.disk.data.datasets[0].data = [...metricsHistory.disk];
    charts.disk.update();

    // Update detailed charts with simple indices
    charts.resource.data.datasets[0].data.push({
        x: dataIndex,
        y: stats.cpu_absolute
    });
    charts.resource.data.datasets[1].data.push({
        x: dataIndex,
        y: memoryPercentage
    });

    charts.networkDetail.data.datasets[0].data.push({
        x: dataIndex,
        y: stats.network.rx_bytes
    });
    charts.networkDetail.data.datasets[1].data.push({
        x: dataIndex,
        y: stats.network.tx_bytes
    });

    // Remove old data points if we exceed MAX_HISTORY
    if (charts.resource.data.datasets[0].data.length > MAX_HISTORY) {
        charts.resource.data.datasets.forEach(dataset => {
            dataset.data.shift();
        });
        charts.networkDetail.data.datasets.forEach(dataset => {
            dataset.data.shift();
        });
    }

    dataIndex++;
    charts.resource.update();
    charts.networkDetail.update();
}

// WebSocket connection via server-side proxy
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = new WebSocket(`${protocol}//${window.location.host}/api/server/${serverId}/ws`);

    socket.onopen = () => {
        console.log('WebSocket connected via proxy');
        // Request initial stats
        socket.send(JSON.stringify({ 
            event: 'send stats', 
            args: [null] 
        }));
    };

    socket.onmessage = (event) => {
        const message = JSON.parse(event.data);

        switch (message.event) {
            case 'auth success':
                console.log('WebSocket authenticated');
                socket.send(JSON.stringify({ 
                    event: 'send stats', 
                    args: [null] 
                }));
                break;

            case 'stats':
                const stats = JSON.parse(message.args[0]);
                updateMetrics(stats);
                break;
            
            // token expiring/expired is handled server-side now
        }
    };

    socket.onclose = (event) => {
        if (event.code === 4003) {
            // Server is suspended
            showAlert('error', '<%= __("server.statistics.alerts.suspended_title") %>', '<%= __("server.statistics.alerts.suspended_body", { discord: "discord.gg/" + settings.discord }) %>', 100000);
            return;
        }
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 5000);
    };

    socket.onerror = (error) => {
        console.error('WebSocket error:', error);
    };
}

// Initialize
if (document.readyState !== "loading") {
    // Load server details
    fetch(`/api/server/${serverId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('server-name').textContent = data.attributes.name;
            document.getElementById('server-description').textContent = 
                data.attributes.description || '<%= __('server.statistics.no_description') %>';
        });

    // Connect WebSocket
    connectWebSocket();

    // Request stats periodically
    setInterval(() => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ 
                event: 'send stats', 
                args: [null] 
            }));
        }
    }, 1000);
}
</script>
<%- include('../components/bottom') %>
