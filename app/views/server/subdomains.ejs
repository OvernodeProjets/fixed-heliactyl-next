<%- include('../components/top') %>
<main class="flex-grow container mx-auto px-4 py-8">
    <%- include('../components/server_header', {
        backButtonText: __('website.subdomains.back_to_list')
    }) %>
<div id="alert-container" class="mb-4 space-y-2"></div>
<%- include('../components/server') %>

    <!-- Subdomains Section -->
    <div class="bg-white/5 rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-semibold text-white"><%= __('website.subdomains.title') %></h2>
                <p class="text-gray-400 text-sm mt-1"><%= __('website.subdomains.subtitle') %></p>
            </div>
            <button id="create-subdomain" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 hover:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <%= __('website.subdomains.add_domain') %>
            </button>
        </div>

        <!-- Loading State -->
        <div id="subdomains-loading" class="text-center py-12">
            <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <!-- Subdomains List -->
        <div id="subdomains-list" class="hidden space-y-4">
            <!-- Subdomains will be populated here -->
        </div>

        <!-- Empty State -->
        <div id="subdomains-empty" class="hidden text-center py-12">
            <div class="mx-auto h-16 w-16 bg-white/5 flex items-center justify-center rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-white"><%= __('website.subdomains.empty_title') %></h3>
            <p class="mt-2 text-gray-400"><%= __('website.subdomains.empty_desc') %></p>
        </div>
    </div>
</main>

<!-- Create Subdomain Modal -->
<div id="create-subdomain-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
    <div class="bg-[#1a1c20] rounded-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-semibold text-white mb-4"><%= __('website.subdomains.modal_title') %></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2"><%= __('website.subdomains.domain_selection') %></label>
                <select id="domain-select" class="w-full p-3 bg-black/20 text-white border border-transparent rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition mb-4">
                    <option value=""><%= __('website.subdomains.select_domain') %></option>
                    <% settings.cloudflare.domains.forEach(function(domain) { %>
                        <% if (domain.enabled) { %>
                            <option value="<%= domain.name %>" <%= domain.is_default ? 'selected' : '' %>>.<%= domain.domain %></option>
                        <% } %>
                    <% }); %>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2"><%= __('website.subdomains.subdomain_name') %></label>
                <div class="flex items-center">
                    <input type="text" id="subdomain-input" class="flex-1 p-3 bg-black/20 text-white border border-transparent rounded-l-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition" placeholder="<%= __('website.subdomains.subdomain_placeholder') %>">
                    <span id="domain-suffix" class="bg-black/30 text-gray-400 py-3 px-4 rounded-r-lg border-l border-white/10"><%= __('website.subdomains.suffix_placeholder') %></span>
                </div>
                <p class="mt-2 text-sm text-gray-400"><%= __('website.subdomains.rules') %></p>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button id="cancel-create" class="px-4 py-2 bg-zinc-600 hover:bg-zinc-700 text-white rounded-lg transition"><%= __('website.subdomains.cancel') %></button>
<button id="confirm-create" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition"><%= __('website.subdomains.create') %></button>
        </div>
    </div>
</div>

<!-- Error/Success Toast -->
<div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg hidden"></div>

<script>
    const serverId = new URLSearchParams(window.location.search).get('id');
    
    // Load server details and subdomains
    // Initialize availableDomains from settings
    const availableDomains = JSON.parse('<%- JSON.stringify(settings.cloudflare.domains) %>');

    function loadServerDetails() {
        fetch(`/api/server/${serverId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('server-name').textContent = data.attributes.name;
            document.getElementById('server-description').textContent = data.attributes.description || "<%= __('website.subdomains.errors.load_details') %>";
            })
            .catch(error => {
                console.error('Error fetching server details:', error);
                showToast('<%= __('website.subdomains.errors.load_details') %>', 'error');
            });
    }

    // Set initial domain suffix
    function initializeDomainSuffix() {
        const domainSelect = document.getElementById('domain-select');
        const selectedDomain = availableDomains.find(d => d.name === domainSelect.value);
        if (selectedDomain) {
            updateDomainSuffix(selectedDomain.domain);
        }
    }

    // Call initializeDomainSuffix when page loads
    initializeDomainSuffix();

    function updateDomainSuffix(domain) {
        document.getElementById('domain-suffix').textContent = `.${domain}`;
    }

    function loadSubdomains() {
        document.getElementById('subdomains-loading').classList.remove('hidden');
        document.getElementById('subdomains-list').classList.add('hidden');
        document.getElementById('subdomains-empty').classList.add('hidden');

        fetch(`/api/server/${serverId}/subdomains`)
            .then(response => response.json())
            .then(data => {
                const subdomainsList = document.getElementById('subdomains-list');
                subdomainsList.innerHTML = '';

                if (!data.subdomains || data.subdomains.length === 0) {
                    document.getElementById('subdomains-empty').classList.remove('hidden');
                    return;
                }

                subdomainsList.classList.remove('hidden');
                data.subdomains.forEach(subdomain => {
                    const subdomainCard = createSubdomainCard(subdomain);
                    subdomainsList.appendChild(subdomainCard);
                });
            })
            .catch(error => {
                console.error('Error loading subdomains:', error);
                showToast('<%= __('website.subdomains.errors.load_subdomains') %>', 'error');
            })
            .finally(() => {
                document.getElementById('subdomains-loading').classList.add('hidden');
            });
    }

function createSubdomainCard(subdomain) {
    const div = document.createElement('div');
    div.className = 'bg-white/5 rounded-lg p-4 hover:bg-white/10 transition-colors duration-200';
    
    const domainConfig = availableDomains.find(d => d.domain === subdomain.domain);
    const domainBadge = domainConfig ? 
        `<span class="px-2 py-1 text-xs rounded-full bg-indigo-500/20 text-indigo-300 ml-2">${domainConfig.name}</span>` : '';
    
    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="space-y-1">
                <div class="flex items-center space-x-2">
                    <h3 class="text-white font-medium">${subdomain.name}.${subdomain.domain}</h3>
                    <span class="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-300"><%= __('website.subdomains.active') %></span>
                    ${domainBadge}
                </div>
                <p class="text-sm text-gray-400 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                    </svg>
                    <%= __('website.subdomains.created_at') %> ${(new Date(subdomain.createdAt)).toDateString()}
                </p>
            </div>
            <button onclick="deleteSubdomain('${subdomain.name}', '${subdomain.domain}')" class="text-red-400 hover:text-red-300 transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
            </button>
        </div>
    `;
    return div;
}

    // Modal handling
    const modal = document.getElementById('create-subdomain-modal');
    const createBtn = document.getElementById('create-subdomain');
    const cancelBtn = document.getElementById('cancel-create');
    const confirmBtn = document.getElementById('confirm-create');

    createBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
    });

    cancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        document.getElementById('subdomain-input').value = '';
    });

    confirmBtn.addEventListener('click', createSubdomain);

    function createSubdomain() {
        const subdomain = document.getElementById('subdomain-input').value.trim();
        const selectedDomain = document.getElementById('domain-select').value;
        
        if (!subdomain) {
            showToast('<%= __('website.subdomains.errors.enter_subdomain') %>', 'error');
            return;
        }

        if (!selectedDomain) {
            showToast('<%= __('website.subdomains.errors.select_domain') %>', 'error');
            return;
        }

        if (!/^[a-z0-9-]+$/i.test(subdomain)) {
            showToast('<%= __('website.subdomains.errors.invalid_format') %>', 'error');
            return;
        }

        fetch(`/api/server/${serverId}/subdomains`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                subdomain,
                domainName: selectedDomain
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('<%= __('website.subdomains.errors.create_failed') %>');
            return response.json();
        })
        .then(data => {
            modal.classList.add('hidden');
            document.getElementById('subdomain-input').value = '';
            showToast('<%= __('website.subdomains.success.create') %>', 'success');
            loadSubdomains();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message || '<%= __('website.subdomains.errors.create_failed') %>', 'error');
        });
    }

function deleteSubdomain(subdomain, domain) {
    if (!confirm('<%= __('website.subdomains.confirm_delete', { fqdn: "__FQDN__" }) %>'.replace('__FQDN__', `${subdomain}.${domain}`))) return;

    fetch(`/api/server/${serverId}/subdomains/${subdomain}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) throw new Error('<%= __('website.subdomains.errors.delete_failed') %>');
        showToast('<%= __('website.subdomains.success.delete') %>', 'success');
        loadSubdomains();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('<%= __('website.subdomains.errors.delete_failed') %>', 'error');
    });
}

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 z-50 rounded-lg shadow-lg ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } text-white flex items-center space-x-2`;
        
        toast.innerHTML = `
            ${type === 'success' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            `}
            <span>${message}</span>
        `;
        
        toast.classList.remove('hidden');
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Domain selector event handler
    document.getElementById('domain-select').addEventListener('change', (e) => {
        const selectedDomain = availableDomains.find(d => d.name === e.target.value);
        if (selectedDomain) {
            updateDomainSuffix(selectedDomain.domain);
        } else {
            updateDomainSuffix('Select a domain');
        }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        loadServerDetails();
        initializeDomainSuffix();
        loadSubdomains();
    });
</script>
<%- include('../components/bottom') %>