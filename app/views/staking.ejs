<%- include('./components/top') %>

<style>
    select option {
        background-color: #1a1d21;
        color: white;
        padding: 12px;
        margin: 4px 0;
    }
    
    select option:hover {
        background-color: rgba(99, 102, 241, 0.1);
    }
</style>

<main class="flex-grow container mx-auto px-4 py-8">
    <!-- Migration Alert -->
    <div id="migration-alert" class="hidden mb-6">
        <div class="bg-indigo-500/20 border border-indigo-500/50 rounded-2xl p-4 text-indigo-200">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-indigo-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-indigo-200"><%= __('staking.migration.title') %></h3>
                    <div class="mt-2 text-sm text-indigo-200">
                        <p><%= __('staking.migration.description') %></p>
                        <ul class="list-disc list-inside mt-2">
                            <li><%= __('staking.migration.feature_1') %></li>
                            <li><%= __('staking.migration.feature_2') %></li>
                            <li><%= __('staking.migration.feature_3') %></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('./components/header', {
        title: __('staking.title'),
        subtitle: __('staking.subtitle', { currency: settings.website.currency }),
        breadcrumbItem: __('breadcrumbs.staking')
    }) %>

    <div class="max-w-4xl mx-auto mt-5">
        <!-- Balance Overview -->
        <div class="bg-white/5 rounded-2xl p-6 mb-8">
            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <p class="text-gray-400 text-sm"><%= __('staking.balance.available') %></p>
                    <p class="text-3xl font-bold" id="available-balance"><%= __('staking.balance.loading') %></p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm"><%= __('staking.balance.total_staked') %></p>
                    <p class="text-3xl font-bold" id="total-staked"><%= __('staking.balance.loading') %></p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm"><%= __('staking.balance.total_earnings') %></p>
                    <p class="text-3xl font-bold" id="total-earnings"><%= __('staking.balance.loading') %></p>
                </div>
            </div>
        </div>

        <!-- Staking Positions -->
        <div class="bg-white/5 rounded-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold"><%= __('staking.positions.title') %></h2>
                <button id="new-stake-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors duration-200">
                    <%= __('staking.positions.new_stake') %>
                </button>
            </div>
            <div id="staking-positions" class="space-y-4">
                <!-- Positions will be populated here -->
                <div class="text-center text-gray-400 py-8" id="no-positions-message">
                    <%= __('staking.positions.no_positions') %>
                </div>
            </div>
        </div>

        <!-- APY Tiers -->
        <div class="bg-white/5 rounded-2xl p-6">
            <h2 class="text-xl font-semibold mb-6"><%= __('staking.tiers.title') %></h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium"><%= __('staking.tiers.30d.title') %></h3>
                        <span class="text-indigo-400"><%= __('staking.tiers.30d.apr') %></span>
                    </div>
                    <p class="text-sm text-gray-400"><%= __('staking.tiers.30d.description') %></p>
                </div>
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium"><%= __('staking.tiers.90d.title') %></h3>
                        <span class="text-indigo-400"><%= __('staking.tiers.90d.apr') %></span>
                    </div>
                    <p class="text-sm text-gray-400"><%= __('staking.tiers.90d.description') %></p>
                </div>
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium"><%= __('staking.tiers.180d.title') %></h3>
                        <span class="text-indigo-400"><%= __('staking.tiers.180d.apr') %></span>
                    </div>
                    <p class="text-sm text-gray-400"><%= __('staking.tiers.180d.description') %></p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- New Stake Modal -->
<div id="stake-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden opacity-0 transition-all duration-300">
    <div class="bg-[#191c20] rounded-2xl p-6 w-[85%] md:w-[50%] transform transition-all duration-300 scale-95">
        <h3 class="text-xl font-semibold mb-6"><%= __('staking.modal.create_title') %></h3>
        <form id="stake-form">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-400 mb-1"><%= __('staking.modal.amount_label') %></label>
                <div class="relative">
                    <input type="number" id="stake-amount" required min="10" step="0.01"
                           class="w-full px-3 py-2 pr-17 bg-white/5 border border-white/10 rounded-xl text-white focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="absolute right-3 top-2 text-gray-400"><%= settings.website.currency %></span>
                </div>
                <p class="mt-1 text-sm text-gray-400"><%= __('staking.modal.minimum', { currency: settings.website.currency }) %></p>
            </div>
            <div class="mb-6 relative">
                <label class="block text-sm font-medium text-gray-400 mb-1"><%= __('staking.modal.lock_period_label') %></label>
                <select id="lock-period" required
                        class="w-full px-4 py-3 bg-[#1a1d21] border border-indigo-500/20 rounded-xl text-white
                               appearance-none cursor-pointer hover:border-indigo-500/40 transition-colors duration-200
                               focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500/30 focus:outline-none">
                    <option value="30d" class="py-3 px-4 hover:bg-indigo-500/10 transition-colors duration-200">
                        <div class="flex justify-between items-center">
                            <span class="font-medium"><%= __('staking.tiers.30d.title') %></span>
                            <span class="text-indigo-400"><%= __('staking.tiers.30d.apr') %></span>
                        </div>
                    </option>
                    <option value="90d" class="py-3 px-4 hover:bg-indigo-500/10 transition-colors duration-200">
                        <div class="flex justify-between items-center">
                            <span class="font-medium"><%= __('staking.tiers.90d.title') %></span>
                            <span class="text-indigo-400"><%= __('staking.tiers.90d.apr') %></span>
                        </div>
                    </option>
                    <option value="180d" class="py-3 px-4 hover:bg-indigo-500/10 transition-colors duration-200">
                        <div class="flex justify-between items-center">
                            <span class="font-medium"><%= __('staking.tiers.180d.title') %></span>
                            <span class="text-indigo-400"><%= __('staking.tiers.180d.apr') %></span>
                        </div>
                    </option>
                </select>
                <!-- Custom arrow icon -->
                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400 mt-6">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-stake" class="px-4 py-2 bg-white/10 text-white rounded-xl font-medium hover:bg-white/20 transition-colors duration-200">
                    <%= __('staking.modal.cancel') %>
                </button>
                <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors duration-200">
                    <%= __('staking.modal.confirm') %>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Position Action Modal -->
<div id="position-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden opacity-0 transition-all duration-300">
    <div class="bg-[#191c20] rounded-2xl p-6 w-[85%] md:w-[50%] transform transition-all duration-300 scale-95">
        <h3 id="position-modal-title" class="text-xl font-semibold mb-6"></h3>
        <div id="position-modal-content"></div>
        <div class="flex justify-end space-x-3 mt-6">
            <button type="button" class="close-position-modal px-4 py-2 bg-white/10 text-white rounded-xl font-medium hover:bg-white/20 transition-colors duration-200">
                <%= __('staking.modal.close') %>
            </button>
            <button type="button" id="position-action-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors duration-200">
            </button>
        </div>
    </div>
</div>

<script>
const stakeModal = document.getElementById('stake-modal');
const positionModal = document.getElementById('position-modal');
const stakeForm = document.getElementById('stake-form');
let currentPositionId = null;
const userinfo = <%- JSON.stringify(req.session.userinfo) %>;

const periodTitles = {
    '30d': '<%= __("staking.tiers.30d.title") %>',
    '90d': '<%= __("staking.tiers.90d.title") %>',
    '180d': '<%= __("staking.tiers.180d.title") %>'
};

async function checkMigration() {
    try {
        const response = await fetch("/api/stake/positions");
        const data = await response.json();
        
        if (data.message && data.message.includes('migrated')) {
            document.getElementById('migration-alert').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error checking migration:', error);
    }
}

async function fetchStakingData() {
    try {
        // Start rendering loading state immediately
        renderStakingPositions(null);
        
        const [positionsResponse] = await Promise.all([
            fetch("/api/stake/positions")
        ]);
        
        if (!positionsResponse.ok) {
            throw new Error('Failed to fetch positions data');
        }
        
        const positionsData = await positionsResponse.json();
        
        // Update UI with fetched data
        updateDashboard(positionsData);
        renderStakingPositions(positionsData.positions);
    } catch (error) {
        console.error('Error fetching staking data:', error);
        showError('<%= __("staking.messages.error_load") %>');
        // Show error state in positions container
        const container = document.getElementById('staking-positions');
        if (container) {
            container.innerHTML = `
                <div class="text-center text-red-400 py-8">
                    <%= __("staking.positions.error") %>
                </div>
            `;
        }
    }
}

function updateDashboard(positionsData) {
    const totalStaked = positionsData.positions.reduce((sum, pos) => sum + pos.amount, 0);
    const totalEarnings = positionsData.positions.reduce((sum, pos) => sum + pos.currentEarnings, 0);
    
    document.getElementById('available-balance').textContent = `<%= coins.toFixed(2) %> <%= settings.website.currency %>`;
    document.getElementById('total-staked').textContent = `${totalStaked.toFixed(2)} <%= settings.website.currency %>`;
    document.getElementById('total-earnings').textContent = `${totalEarnings.toFixed(2)} <%= settings.website.currency %>`;
}

function renderStakingPositions(positions) {
    const container = document.getElementById('staking-positions');
    const noPositionsMsg = document.getElementById('no-positions-message');

    const currency = '<%= settings.website.currency %>';
    const txtStakedAmount = '<%= __("staking.positions.staked_amount") %>';
    const txtLockPeriod = '<%= __("staking.positions.lock_period") %>';
    const txtCurrentEarnings = '<%= __("staking.positions.current_earnings") %>';
    const txtUnlockDate = '<%= __("staking.positions.unlock_date") %>';
    const txtManage = '<%= __("staking.positions.manage") %>';
    const txtLoading = '<%= __("staking.positions.loading") %>';
    const txtNoPositions = '<%= __("staking.positions.no_positions") %>';

    // Guard clause for container
    if (!container) {
        console.warn('Staking positions container not found');
        return;
    }

    // Handle no-positions message if element exists
    if (noPositionsMsg) {
        if (!positions || positions.length === 0) {
            noPositionsMsg.classList.remove('hidden');
        } else {
            noPositionsMsg.classList.add('hidden');
        }
    }

    // Only render if we have a valid container
    // Show loading state immediately
    if (!positions) {
        container.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                <svg class="inline w-6 h-6 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-2">${txtLoading}</span>
            </div>
        `;
        return;
    }

    // Show empty state if no positions
    if (positions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                ${txtNoPositions}
            </div>
        `;
        return;
    }

    container.innerHTML = positions.map(position => `
        <div class="bg-white/5 border border-white/10 rounded-xl p-4 hover:bg-white/10 transition-colors duration-200">
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <p class="text-sm text-gray-400">${txtStakedAmount}</p>
                    <p class="text-lg font-medium">${position.amount.toFixed(2)} ${currency}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">${txtLockPeriod}</p>
                    <p class="text-lg font-medium">${periodTitles[position.lockPeriod] || position.lockPeriod}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">${txtCurrentEarnings}</p>
                    <p class="text-lg font-medium text-indigo-400">+${position.currentEarnings.toFixed(2)} ${currency}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">${txtUnlockDate}</p>
                    <p class="text-lg font-medium">${new Date(position.unlockTime).toLocaleDateString()}</p>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="showPositionActions('${position.positionId}')"
                        class="px-4 py-2 bg-white/10 text-white rounded-xl font-medium hover:bg-white/20 transition-colors duration-200">
                    ${txtManage}
                </button>
                ${position.currentEarnings > 0 ? `
                    <button onclick="claimRewards('${position.positionId}')"
                            class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors duration-200 hidden">
                        ${'<%= __("staking.positions.claim_prefix") %>'} ${position.currentEarnings.toFixed(2)} ${currency}
                    </button>
                ` : ''}
            </div>
            ${position.isLocked ? `
                <div class="mt-4 text-sm text-indigo-400">
                    <svg class="inline-block w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    ${'<%= __("staking.positions.locked_until_prefix") %>'} ${new Date(position.unlockTime).toLocaleDateString()}
                </div>
            ` : ''}
        </div>
    `).join('');
}

async function showPositionActions(positionId) {
    try {
        const response = await fetch(`/api/stake/positions/${positionId}`);
        const position = (await response.json()).position;
        currentPositionId = positionId;

        const currency = '<%= settings.website.currency %>';
        const txtManageTitle = '<%= __("staking.modal.manage_title") %>';
        const txtStakedAmount = '<%= __("staking.positions.staked_amount") %>';
        const txtLockPeriod = '<%= __("staking.positions.lock_period") %>';
        const txtCurrentEarnings = '<%= __("staking.positions.current_earnings") %>';
        const txtAPRBonus = '<%= __("staking.modal.apr_bonus") %>';
        const txtEarlyWarning = '<%= __("staking.modal.early_warning") %>';
        const txtEarlyWarningText = '<%= __("staking.modal.early_warning_text") %>';
        const txtUnstakeEarly = '<%= __("staking.modal.unstake_early") %>';
        const txtUnstake = '<%= __("staking.modal.unstake") %>';

        const modalTitle = document.getElementById('position-modal-title');
        const modalContent = document.getElementById('position-modal-content');
        const actionBtn = document.getElementById('position-action-btn');

        modalTitle.textContent = txtManageTitle;
        modalContent.innerHTML = `
            <div class="space-y-4">
                <div class="bg-white/5 rounded-xl p-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-400">${txtStakedAmount}</p>
                            <p class="text-lg font-medium">${position.amount.toFixed(2)} ${currency}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">${txtLockPeriod}</p>
                            <p class="text-lg font-medium">${periodTitles[position.lockPeriod] || position.lockPeriod}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">${txtCurrentEarnings}</p>
                            <p class="text-lg font-medium text-indigo-400">+${position.currentEarnings.toFixed(2)} ${currency}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">${txtAPRBonus}</p>
                            <p class="text-lg font-medium">+${getAPRBonus(position.lockPeriod)}%</p>
                        </div>
                    </div>
                </div>
                ${position.isLocked ? `
                    <div class="bg-indigo-500/20 border border-indigo-500/50 rounded-xl p-4">
                        <p class="text-sm text-indigo-200">
                            <strong>${txtEarlyWarning}</strong> ${txtEarlyWarningText}
                        </p>
                    </div>
                ` : ''}
            </div>
        `;

        actionBtn.textContent = position.isLocked ? txtUnstakeEarly : txtUnstake;
        actionBtn.onclick = () => confirmUnstake(positionId, position.isLocked);

        showModal('position-modal');
    } catch (error) {
        console.error('Error fetching position details:', error);
        showError('<%= __("staking.messages.error_load") %>');
    }
}

function getAPRBonus(lockPeriod) {
    const bonuses = {
        '30d': 20,
        '90d': 50,
        '180d': 100
    };
    return bonuses[lockPeriod] || 0;
}

async function confirmUnstake(positionId, isLocked) {
    const currency = '<%= settings.website.currency %>';
    const txtConfirmUnstakeEarly = '<%= __("staking.messages.confirm_unstake_early") %>';
    const txtConfirmUnstake = '<%= __("staking.messages.confirm_unstake") %>';
    const txtErrorUnstake = '<%= __("staking.messages.error_unstake") %>';

    const confirmMessage = isLocked ? txtConfirmUnstakeEarly : txtConfirmUnstake;

    if (confirm(confirmMessage)) {
        try {
            const response = await fetch('/unstake', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ positionId })
            });

            const data = await response.json();
            if (response.ok) {
                showSuccess('<%= __("staking.messages.unstaked_success_generic") %>');
                hideModal('position-modal');
                fetchStakingData();
            } else {
                showError(data.error);
            }
        } catch (error) {
            console.error('Error unstaking position:', error);
            showError(txtErrorUnstake);
        }
    }
}

async function claimRewards(positionId) {
    const currency = '<%= settings.website.currency %>';
    const txtErrorClaim = '<%= __("staking.messages.error_claim") %>';

    try {
        const response = await fetch('/api/stake/claim', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ positionId })
        });

        const data = await response.json();
        if (response.ok) {
            showSuccess('<%= __("staking.messages.claimed_success_generic") %>');
            fetchStakingData();
        } else {
            showError(data.error);
        }
    } catch (error) {
        console.error('Error claiming rewards:', error);
        showError(txtErrorClaim);
    }
}

// Modal Controls
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modal.querySelector('.transform').classList.remove('scale-95');
    }, 10);
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('opacity-0');
    modal.querySelector('.transform').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

// Notifications
function showSuccess(message) {
    // Implementation of toast notification
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300 opacity-0 translate-y-2';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-2');
    }, 10);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showError(message) {
    // Similar to showSuccess but with red styling
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300 opacity-0 translate-y-2';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-2');
    }, 10);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Event Listeners
document.getElementById('new-stake-btn').addEventListener('click', () => showModal('stake-modal'));
document.getElementById('cancel-stake').addEventListener('click', () => hideModal('stake-modal'));
document.querySelectorAll('.close-position-modal').forEach(btn => {
    btn.addEventListener('click', () => hideModal('position-modal'));
});

stakeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const amount = parseFloat(document.getElementById('stake-amount').value);
    const lockPeriod = document.getElementById('lock-period').value;

    const currency = '<%= settings.website.currency %>';
    const txtErrorCreate = '<%= __("staking.messages.error_create") %>';

    try {
        const response = await fetch('/api/stake', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, lockPeriod })
        });

        const data = await response.json();
        if (response.ok) {
            showSuccess('<%= __("staking.messages.staked_success_generic") %>');
            hideModal('stake-modal');
            stakeForm.reset();
            fetchStakingData();
        } else {
            showError(data.error);
        }
    } catch (error) {
        console.error('Error creating stake:', error);
        showError(txtErrorCreate);
    }
});

// Initialize
checkMigration();
fetchStakingData();
setInterval(fetchStakingData, 30000); // Refresh every 30 seconds
</script>

<%- include('./components/bottom') %>