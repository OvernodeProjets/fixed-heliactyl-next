<%- include('./components/top') %>
<!-- Main Content -->
<main class="flex-grow container mx-auto px-4 py-8">
    <div class="flex justify-between items-center w-full mx-auto pb-4">
        <!-- Welcome text and subtext -->
        <div class="flex flex-col">
            <h1 class="text-xl font-semibold mb-0.5 heavy"><%= __('servers.title') %></h1>
            <p class="text-gray-400 text-md"><%= __('servers.subtitle', { name: settings.name }) %></p>
        </div>

        <!-- Actions -->
        <div class="flex flex-col md:flex-row  items-center gap-3">
            <!-- New Server Button -->
<div class="relative inline-block" x-data="{ open: false }">
  <button 
    @click="open = !open"
    class="hover:scale-95 flex items-center justify-center h-11 gap-2 px-5 text-sm font-medium text-white transition-all duration-200 rounded-full shadow bg-indigo-500 hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-800 focus:ring-offset-2 ring-offset-gray-200 hover:shadow-none"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="size-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
    </svg>
    <span><%= __('common.create') %></span>
    <svg 
      xmlns="http://www.w3.org/2000/svg" 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="currentColor" 
      class="size-4 transition-transform duration-200"
      :class="open ? 'rotate-180' : ''"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
    </svg>
  </button>

  <div 
    x-show="open"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 scale-95 -translate-y-2"
    x-transition:enter-end="opacity-100 scale-100 translate-y-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100 scale-100 translate-y-0"
    x-transition:leave-end="opacity-0 scale-95 -translate-y-2"
    @click.outside="open = false"
    class="absolute right-0 mt-2 w-40 overflow-hidden md:w-48 rounded-xl bg-white/5 backdrop-blur-xl border border-white/10 shadow-lg"
    style="display: none;"
  >
    <div class="py-1 md:py-2">
      <a href="/server/new" class="flex items-center gap-2 px-3 md:px-4 py-2.5 text-sm text-white/90 hover:bg-white/10 transition-colors">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-4">
  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 17.25v-.228a4.5 4.5 0 0 0-.12-1.03l-2.268-9.64a3.375 3.375 0 0 0-3.285-2.602H7.923a3.375 3.375 0 0 0-3.285 2.602l-2.268 9.64a4.5 4.5 0 0 0-.12 1.03v.228m19.5 0a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3m19.5 0a3 3 0 0 0-3-3H5.25a3 3 0 0 0-3 3m16.5 0h.008v.008h-.008v-.008Zm-3 0h.008v.008h-.008v-.008Z" />
</svg>
        <%= __('servers.actions.game_server') %>
      </a>
    </div>
  </div>
</div>
    <% if (pterodactyl.root_admin) { %>
    <!-- Admin View Switcher -->
    <button onclick="switchServerView()" id="view-toggle-btn" class="hover:scale-95 flex items-center justify-center h-11 gap-2 px-5 text-sm font-medium text-white transition-all duration-200 rounded-full shadow bg-white/10 hover:bg-white/20 focus:ring-2 focus:ring-white/20 focus:ring-offset-2 ring-offset-gray-900 hover:shadow-none">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
        </svg>
        <span>Others' Servers</span>
    </button>
    <% } %>
</div>
    </div>
<div id="alert-container" class="mb-4 space-y-2"></div>
    <div id="user-servers-container">
        <!-- Servers List Header (hidden on mobile) -->
        <div class="hidden md:grid px-6 py-3 mt-6 grid-cols-12 gap-4 items-center text-sm font-medium text-white/50">
            <div class="col-span-2"><%= __('servers.columns.server') %></div>
            <div class="col-span-2"><%= __('servers.columns.status') %></div>
            <div class="col-span-2"><%= __('servers.columns.memory') %></div>
            <div class="col-span-2"><%= __('servers.columns.cpu') %></div>
            <div class="col-span-3 ml-4"><%= __('servers.columns.ip_address') %></div>
        </div>
    
        <% pterodactyl.data = (pterodactyl && pterodactyl.relationships && pterodactyl.relationships.servers && pterodactyl.relationships.servers.data) ? pterodactyl.relationships.servers.data : [] %>
        <!-- Servers List -->
        <div class="divide-y divide-white/5 mt-4 md:mt-0" id="servers-list">
            <% if (pterodactyl.data.length === 0) { %>
                <div class="px-6 py-8 text-center text-white/60">
                    <p class="text-lg mb-2"><%= __('servers.no_servers') %></p>
                    <p class="text-sm"><%= __('servers.get_started') %></p>
                </div>
            <% } else { %>
                <% pterodactyl.data.forEach(server => { %>
    <div class="server-row mb-4 bg-white/5 rounded-2xl hover:bg-white/10 border-2 border-dashed border-transparent hover:border-white/5 transition px-4 md:px-6 py-4 flex flex-col gap-3 md:grid md:grid-cols-12 md:gap-4 md:items-center cursor-pointer"
         data-server-id="<%= server.attributes.identifier %>"
         data-server-numeric="<%= server.attributes.id %>"
         data-egg="<%= server.attributes.egg %>"
         onclick="window.location.href='/server/manage?id=<%= server.attributes.identifier%>&numeric=<%= server.attributes.id%>&mode=server'">
                        
                        <!-- Server Name & Status (mobile: inline row) -->
                        <div class="flex items-center justify-between md:contents">
                            <div class="md:col-span-2">
                                <div class="font-medium text-white text-sm md:text-base"><%= server.attributes.name %></div>
                            </div>
    
                            <div class="md:col-span-2">
                                <div class="inline-flex items-center px-2 md:px-3 py-1 rounded-full text-xs font-medium bg-zinc-500/20 text-zinc-300">
                                    <div class="size-2 rounded-full bg-zinc-400 mr-1.5 md:mr-2 status-indicator"></div>
                                    <span class="status-text"><%= __('servers.status.connecting') %></span>
                                </div>
                            </div>
                        </div>
    
                        <!-- Memory & CPU (mobile: side by side) -->
                        <div class="flex gap-4 md:contents">
                            <div class="flex-1 md:col-span-2">
                                <div class="text-xs text-white/50 mb-1 md:hidden">Memory</div>
                                <div class="flex items-center gap-2">
                                    <div class="w-full bg-white/10 rounded-full h-1.5">
                                        <div class="memory-bar bg-indigo-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                    <span class="text-xs memory-text whitespace-nowrap">0/<%= server.attributes.limits.memory %>MiB</span>
                                </div>
                            </div>
    
                            <div class="flex-1 md:col-span-2">
                                <div class="text-xs text-white/50 mb-1 md:hidden">CPU</div>
                                <div class="flex items-center gap-2">
                                    <div class="w-full bg-white/10 rounded-full h-1.5">
                                        <div class="cpu-bar bg-indigo-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                    <span class="text-xs cpu-text">0%</span>
                                </div>
                            </div>
                        </div>
    
                        <!-- IP Address -->
                        <div class="md:col-span-3 md:ml-4">
                            <div class="text-xs font-mono text-white/70 bg-white/5 border border-white/5 px-3 py-1.5 rounded-lg shadow-sm overflow-x-auto">
                                <span class="server-address whitespace-nowrap"><%= __('servers.fetching') %></span>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>

    <!-- Shared Servers Section -->
    <div class="mt-8 hidden" id="shared-servers-section">
        <h2 class="text-xl font-semibold mb-4 heavy"><%= __('servers.shared_servers') %></h2>
        <div class="hidden md:grid rounded-t-xl px-6 py-3 grid-cols-12 gap-4 items-center text-sm font-medium text-gray-400">
        <div class="col-span-2"><%= __('servers.columns.server') %></div>
        <div class="col-span-2"><%= __('servers.columns.status') %></div>
        <div class="col-span-2"><%= __('servers.columns.memory') %></div>
        <div class="col-span-2"><%= __('servers.columns.cpu') %></div>
        <div class="col-span-3 ml-4"><%= __('servers.columns.ip_address') %></div>
        </div>
        <div class="divide-y divide-white/5" id="shared-servers-list"></div>
    </div>

    <% if (pterodactyl.root_admin) { %>
    <!-- Admin All Servers Section -->
    <div class="mt-4 hidden" id="admin-servers-container">
        
        <!-- Headers -->
        <div class="hidden md:grid rounded-t-xl px-6 py-3 grid-cols-12 gap-4 items-center text-sm font-medium text-gray-400">
            <div class="col-span-2"><%= __('servers.columns.server') %></div>
            <div class="col-span-2">Owner</div>
            <div class="col-span-2"><%= __('servers.columns.memory') %></div>
            <div class="col-span-2"><%= __('servers.columns.cpu') %></div>
            <div class="col-span-3 ml-4"><%= __('servers.columns.ip_address') %></div>
        </div>
        
        <div class="divide-y divide-white/5" id="admin-servers-list">
            <!-- Servers will be loaded here -->
        </div>

        <!-- Pagination Controls -->
        <div class="mt-4 flex items-center justify-between px-2" id="admin-pagination">
            <button onclick="changeAdminPage(-1)" id="prev-page-btn" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm text-gray-300 transition">
                &larr; Previous
            </button>
            <span class="text-sm text-gray-400" id="page-info">Page 1</span>
            <button onclick="changeAdminPage(1)" id="next-page-btn" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm text-gray-300 transition">
                Next &rarr;
            </button>
        </div>
    </div>
    <% } %>
</main>

<script>
const serverConnections = new Map();
const serverDetails = new Map();

async function fetchServerDetails(serverId) {
    try {
        const response = await fetch(`/api/server/${serverId}`);
        const data = await response.json();
        serverDetails.set(serverId, data);
        
        const serverRow = document.querySelector(`[data-server-id="${serverId}"]`);
        if (serverRow) {
            const addressElement = serverRow.querySelector('.server-address');
            const defaultAllocation = data.attributes.relationships.allocations.data.find(
                allocation => allocation.attributes.is_default
            );
            
            if (defaultAllocation) {
                addressElement.textContent = `${defaultAllocation.attributes.ip_alias}:${defaultAllocation.attributes.port}`;
            }
        }
    } catch (error) {
        console.error('Error fetching server details:', error);
    }
}

function connectToServer(serverId, numericId) {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socket = new WebSocket(`${protocol}//${window.location.host}/api/server/${serverId}/ws`);
    const serverRow = document.querySelector(`[data-server-id="${serverId}"]`);
    
    socket.onopen = () => {
        console.log(`Server ${serverId} connected via proxy`);
        socket.send(JSON.stringify({ event: 'send stats', args: [null] }));
        fetchServerDetails(serverId);
    };

    socket.onmessage = (event) => {
        const message = JSON.parse(event.data);
        
        switch (message.event) {
            case 'auth success':
                socket.send(JSON.stringify({ event: 'send stats', args: [null] }));
                fetchServerDetails(serverId);
                break;
            
            case 'stats':
                const stats = JSON.parse(message.args[0]);
                updateServerStats(serverRow, stats);
                // Stats message also contains the server state
                if (stats.state) {
                    updateServerStatus(serverRow, stats.state);
                }
                break;
            
            case 'status':
                updateServerStatus(serverRow, message.args[0]);
                break;
        }
    };

    socket.onclose = (event) => {
        if (event.code === 4003) {
            // Server is suspended
            console.log(`Server ${serverId} is suspended`);
            showAlert('error', '<%= __("servers.alerts.suspended_title") %>', '<%= __("servers.alerts.suspended_body", { discord: "discord.gg/" + settings.discord }) %>', 100000);
            updateServerStatus(serverRow, 'suspended');
            return;
        }
        console.log(`Server ${serverId} disconnected, reconnecting...`);
        setTimeout(() => connectToServer(serverId, numericId), 5000);
    };

    socket.onerror = (error) => {
        console.error(`Server ${serverId} WebSocket error:`, error);
    };

    serverConnections.set(serverId, socket);
}


function updateServerStats(serverRow, stats) {
    if (!serverRow) return;

    // Update Memory
    const memoryUsage = (stats.memory_bytes / 1024 / 1024).toFixed(0);
    const memoryLimit = (stats.memory_limit_bytes / 1024 / 1024).toFixed(0);
    const memoryPercent = (stats.memory_bytes / stats.memory_limit_bytes * 100).toFixed(0);
    
    const memoryBar = serverRow.querySelector('.memory-bar');
    const memoryText = serverRow.querySelector('.memory-text');
    
    memoryBar.style.width = `${memoryPercent}%`;
    memoryText.textContent = `${memoryUsage}MiB`;

    // Update CPU
    const cpuPercent = (stats.cpu_absolute / 100).toFixed(0);
    const cpuBar = serverRow.querySelector('.cpu-bar');
    const cpuText = serverRow.querySelector('.cpu-text');
    
    cpuBar.style.width = `${cpuPercent}%`;
    cpuText.textContent = `${cpuPercent}%`;

    // Update colors based on usage
    updateResourceColors(memoryBar, memoryPercent);
    updateResourceColors(cpuBar, cpuPercent);
}

function updateResourceColors(bar, percent) {
    bar.classList.remove('bg-emerald-500', 'bg-yellow-500', 'bg-red-500', 'bg-indigo-500');
    if (percent > 90) {
        bar.classList.add('bg-red-500');
    } else if (percent > 70) {
        bar.classList.add('bg-yellow-500');
    } else if (percent > 0) {
        bar.classList.add('bg-emerald-500');
    } else {
        bar.classList.add('bg-indigo-500');
    }
}

function updateServerStatus(serverRow, status) {
    if (!serverRow) return;

    const statusIndicator = serverRow.querySelector('.status-indicator');
    const statusText = serverRow.querySelector('.status-text');
    const statusContainer = statusIndicator.parentElement;

    statusIndicator.classList.remove('bg-emerald-400', 'bg-red-400', 'bg-yellow-400', 'bg-zinc-400');
    statusContainer.classList.remove('bg-emerald-500/20', 'bg-red-500/20', 'bg-yellow-500/20', 'bg-zinc-500/20');
    statusContainer.classList.remove('text-emerald-300', 'text-red-300', 'text-yellow-300', 'text-zinc-300');

    switch (status) {
        case 'running':
            statusIndicator.classList.add('bg-emerald-400');
            statusContainer.classList.add('bg-emerald-500/20', 'text-emerald-300');
            statusText.textContent = '<%= __("servers.status.online") %>';
            break;
        case 'offline':
            statusIndicator.classList.add('bg-red-400');
            statusContainer.classList.add('bg-red-500/20', 'text-red-300');
            statusText.textContent = '<%= __("servers.status.offline") %>';
            break;
        case 'starting':
            statusIndicator.classList.add('bg-yellow-400');
            statusContainer.classList.add('bg-yellow-500/20', 'text-yellow-300');
            statusText.textContent = '<%= __("servers.status.starting") %>';
            break;
        case 'stopping':
            statusIndicator.classList.add('bg-yellow-400');
            statusContainer.classList.add('bg-yellow-500/20', 'text-yellow-300');
            statusText.textContent = '<%= __("servers.status.stopping") %>';
            break;
        default:
            statusIndicator.classList.add('bg-zinc-400');
            statusContainer.classList.add('bg-zinc-500/20', 'text-zinc-300');
            statusText.textContent = '<%= __("servers.status.unknown") %>';
    }
}

// Initialize server connections
document.querySelectorAll('.server-row').forEach(row => {
    const serverId = row.dataset.serverId;
    const numericId = row.dataset.serverNumeric;
    connectToServer(serverId, numericId);
});

// Fetch and display shared servers
fetch('/api/server/subuser-servers')
    .then(response => response.json())
    .then(servers => {
        if (servers.length > 0) {
            document.getElementById('shared-servers-section').classList.remove('hidden');
            const sharedServersList = document.getElementById('shared-servers-list');
            
            servers.forEach(server => {
                const serverRow = document.createElement('div');
                serverRow.className = 'server-row mb-4 bg-white/5 rounded-2xl hover:bg-white/10 border-2 border-dashed border-transparent hover:border-white/5 transition px-4 md:px-6 py-4 flex flex-col gap-3 md:grid md:grid-cols-12 md:gap-4 md:items-center cursor-pointer';
                serverRow.setAttribute('data-server-id', server.id);
                serverRow.onclick = () => window.location.href = `/server/manage?id=${server.id}&numeric=0`;
                
                serverRow.innerHTML = `
                    <!-- Server Name & Status (mobile: inline row) -->
                    <div class="flex items-center justify-between md:contents">
                        <div class="md:col-span-2">
                            <div class="font-medium text-white text-sm md:text-base">${server.name}</div>
                        </div>

                        <div class="md:col-span-2">
                            <div class="inline-flex items-center px-2 md:px-3 py-1 rounded-full text-xs font-medium bg-zinc-500/20 text-zinc-300">
                                <div class="size-2 rounded-full bg-zinc-400 mr-1.5 md:mr-2 status-indicator"></div>
                                <span class="status-text"><%= __("servers.status.connecting") %></span>
                            </div>
                        </div>
                    </div>

                    <!-- Memory & CPU (mobile: side by side) -->
                    <div class="flex gap-4 md:contents">
                        <div class="flex-1 md:col-span-2">
                            <div class="text-xs text-white/50 mb-1 md:hidden">Memory</div>
                            <div class="flex items-center gap-2">
                                <div class="w-full bg-white/10 rounded-full h-1.5">
                                    <div class="memory-bar bg-indigo-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <span class="text-xs memory-text whitespace-nowrap">0MiB</span>
                            </div>
                        </div>

                        <div class="flex-1 md:col-span-2">
                            <div class="text-xs text-white/50 mb-1 md:hidden">CPU</div>
                            <div class="flex items-center gap-2">
                                <div class="w-full bg-white/10 rounded-full h-1.5">
                                    <div class="cpu-bar bg-indigo-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <span class="text-xs cpu-text">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- IP Address -->
                    <div class="md:col-span-3 md:ml-4">
                        <div class="text-xs font-mono text-white/70 bg-white/5 border border-white/5 px-3 py-1.5 rounded-lg shadow-sm overflow-x-auto">
                            <span class="server-address whitespace-nowrap"><%= __("servers.fetching") %></span>
                        </div>
                    </div>
                `;
                
                sharedServersList.appendChild(serverRow);
                connectToServer(server.id, 0);
            });
        }
    })
    .catch(error => console.error('Error fetching shared servers:', error));

    <% if (pterodactyl.root_admin) { %>
    let currentAdminPage = 1;
    let totalAdminPages = 1;

    function switchServerView() {
        const userContainer = document.getElementById('user-servers-container');
        const adminContainer = document.getElementById('admin-servers-container');
        const toggleBtn = document.getElementById('view-toggle-btn');
        const toggleSpan = toggleBtn.querySelector('span');
        
        const isAdminView = userContainer.classList.contains('hidden');
        
        if (isAdminView) {
            // Switch to User View
            userContainer.classList.remove('hidden');
            adminContainer.classList.add('hidden');
            toggleSpan.textContent = "Others' Servers";
        } else {
            // Switch to Admin View
            userContainer.classList.add('hidden');
            adminContainer.classList.remove('hidden');
            toggleSpan.textContent = "My Servers";
            
            if (document.getElementById('admin-servers-list').children.length === 0) {
                loadAdminServers(currentAdminPage);
            }
        }
    }

    function changeAdminPage(delta) {
        const newPage = currentAdminPage + delta;
        if (newPage >= 1 && newPage <= totalAdminPages) {
            loadAdminServers(newPage);
        }
    }

    function loadAdminServers(page) {
        document.getElementById('admin-servers-list').innerHTML = '<div class="text-center py-8 text-gray-500 italic">Loading...</div>';
        
        fetch(`/api/admin/all_servers?page=${page}`)
            .then(async response => {
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text);
                }
                return response.json();
            })
            .then(data => {
                const servers = data.data; // Pterodactyl responses usually have data: [...]
                const meta = data.meta; // Pagination info
                
                const adminList = document.getElementById('admin-servers-list');
                adminList.innerHTML = '';

                if (!servers || servers.length === 0) {
                     adminList.innerHTML = '<div class="text-center py-4 text-gray-500">No servers found.</div>';
                     return;
                }

                // Update pagination state
                currentAdminPage = meta.pagination.current_page;
                totalAdminPages = meta.pagination.total_pages;
                
                document.getElementById('page-info').textContent = `Page ${currentAdminPage} of ${totalAdminPages}`;
                document.getElementById('prev-page-btn').disabled = currentAdminPage <= 1;
                document.getElementById('next-page-btn').disabled = currentAdminPage >= totalAdminPages;
                
                servers.forEach(server => {
                    const serverRow = document.createElement('div');
                    serverRow.className = 'server-row mb-4 bg-white/5 rounded-2xl hover:bg-white/10 border-2 border-dashed border-transparent hover:border-white/5 transition px-4 md:px-6 py-4 flex flex-col gap-3 md:grid md:grid-cols-12 md:gap-4 md:items-center cursor-pointer';
                    serverRow.onclick = () => window.location.href = `/server/manage?id=${server.attributes.identifier}&numeric=${server.attributes.id}`;
                    
                    const limits = server.attributes.limits || { memory: 0, cpu: 0 };
                    
                    serverRow.innerHTML = `
                        <!-- Server Name -->
                        <div class="flex items-center justify-between md:contents">
                            <div class="md:col-span-2">
                                <div class="font-medium text-white text-sm md:text-base">${server.attributes.name}</div>
                                <div class="text-xs text-gray-500">${server.attributes.identifier}</div>
                            </div>

                            <div class="md:col-span-2">
                                 <div class="text-sm text-gray-400">User ID: ${server.attributes.user}</div>
                            </div>
                        </div>

                        <!-- Limits -->
                        <div class="flex gap-4 md:contents">
                            <div class="flex-1 md:col-span-2">
                                <div class="text-xs text-white/50 mb-1 md:hidden">Memory</div>
                                <span class="text-sm text-gray-400">${limits.memory} MB</span>
                            </div>

                            <div class="flex-1 md:col-span-2">
                                <div class="text-xs text-white/50 mb-1 md:hidden">CPU</div>
                                <span class="text-sm text-gray-400">${limits.cpu}%</span>
                            </div>
                        </div>

                        <!-- IP Address -->
                        <div class="md:col-span-3 md:ml-4">
                            <div class="text-xs font-mono text-white/70 bg-white/5 border border-white/5 px-3 py-1.5 rounded-lg shadow-sm overflow-x-auto w-fit">
                                ${formatAdminServerIP(server)}
                            </div>
                        </div>
                    `;
                    
                    adminList.appendChild(serverRow);
                });
            })
            .catch(error => {
                console.error('Error fetching admin servers:', error);
                document.getElementById('admin-servers-list').innerHTML = `<div class="text-center py-4 text-red-400">Error loading servers: ${error.message}</div>`;
            });
    }

    function formatAdminServerIP(server) {
        try {
            const defaultAllocationId = server.attributes.allocation;
            const allocations = server.attributes.relationships?.allocations?.data;
            
            if (allocations && allocations.length > 0) {
                // Try to find the default allocation
                const defaultAlloc = allocations.find(a => a.attributes.id === defaultAllocationId);
                const alloc = defaultAlloc || allocations[0];
                
                if (alloc && alloc.attributes) {
                    const ip = alloc.attributes.alias || alloc.attributes.ip;
                    const port = alloc.attributes.port;
                    return `${ip}:${port}`;
                }
            }
            return 'No IP';
        } catch (e) {
            console.error('Error formatting IP:', e);
            return 'Error';
        }
    }
    <% } %>

// Cleanup WebSocket connections when leaving the page
window.addEventListener('beforeunload', () => {
    serverConnections.forEach(socket => {
        if (socket.readyState === WebSocket.OPEN) {
            socket.close();
        }
    });
});

// Optional: Reconnect WebSocket when tab becomes visible again
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        serverConnections.forEach((socket, serverId) => {
            if (socket.readyState !== WebSocket.OPEN) {
                connectToServer(serverId);
            }
        });
    }
});

// Refresh stats periodically
setInterval(() => {
    serverConnections.forEach(socket => {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ event: 'send stats', args: [null] }));
        }
    });
}, 10000);
</script>

<%- include('./components/bottom') %>
