<!DOCTYPE html>
<html lang="<%= locale %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= settings.name %> - <%= __('auth.reset.title') %></title>
    <link rel="stylesheet" href="../assets/tailwind.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Space+Grotesk:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        #mainContent {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #mainContent.hide {
            opacity: 0;
            visibility: hidden;
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body style="font-family: 'Inter'" class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Main content -->
    <main id="mainContent" class="flex-grow flex items-center justify-center p-8">
        <div class="py-8 px-6 md:py-12 md:px-8 w-[85%] md:w-[50%]">
            <div class="flex justify-center mb-8">
                <img src="/assets/logo-text.png" class="h-12 hover:scale-90 transition cursor-pointer" alt="Logo">
            </div>
            <h2 class="text-center text-2xl tracking-tight font-semibold text-gray-800" style="font-family: 'Inter'"><%= __('auth.reset.heading') %></h2>
            <p class="text-gray-400 text-center mt-1 font-normal text-sm"><%= __('auth.reset.subtitle') %></p>
            
            <!-- Password Reset Form -->
            <form id="resetForm" class="mt-8 space-y-4">
                <div>
                    <input type="password" id="newPassword" name="newPassword" class="w-full py-2.5 px-4 rounded-full bg-gray-200 text-gray-700 placeholder-gray-400 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500" placeholder="<%= __('auth.reset.new_password_ph') %>" required>
                </div>
                <div>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="w-full py-2.5 px-4 rounded-full bg-gray-200 text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500" placeholder="<%= __('auth.reset.confirm_new_password_ph') %>" required>
                </div>
                <button type="submit" class="w-full py-2.5 px-4 text-white rounded-full transition font-medium bg-gray-800 hover:bg-gray-700">
                    <%= __('auth.reset.btn') %>
                    <span class="spinner" id="resetSpinner"></span>
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-500"><%= __('auth.reset.remember') %> <a href="/auth" class="text-indigo-600 hover:text-indigo-800"><%= __('auth.reset.login') %></a></p>
            </div>
        </div>
    </main>
    <!-- Footer with links and copyright -->
    <footer class="w-full p-4 text-center">
        <p class="text-xs text-gray-400 font-medium">&copy; 2022 - <%= new Date().getFullYear() %> <%= settings.name %>. <%= __('auth.reset.copyright') %> </p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none">
        
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const i18n = JSON.parse('<%- JSON.stringify({ passwordsNoMatch: __("auth.reset.errors.passwords_no_match"), resetSuccess: __("auth.reset.success.reset"), resetFailed: __("auth.reset.errors.failed"), genericError: __("auth.reset.errors.generic") }) %>');
        const resetForm = document.getElementById('resetForm');
        const resetSpinner = document.getElementById('resetSpinner');
        const toast = document.getElementById('toast');

        function showToast(message, type = 'error') {
            toast.textContent = message;
            toast.classList.remove('bg-red-500', 'bg-green-500');
            toast.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100', 'slide-in');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'slide-in');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetSpinner.style.display = 'inline-block';

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const token = getTokenFromURL();

            if (newPassword !== confirmPassword) {
                showToast(i18n.passwordsNoMatch);
                resetSpinner.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token, newPassword }),
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(i18n.resetSuccess, 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showToast(data.error || i18n.resetFailed);
                    resetForm.classList.add('error-shake');
                    setTimeout(() => resetForm.classList.remove('error-shake'), 1000);
                }
            } catch (error) {
                showToast(i18n.genericError);
            } finally {
                resetSpinner.style.display = 'none';
            }
        });
    });
    </script>
</body>
</html>
